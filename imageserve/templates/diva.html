{% extends 'main.html' %}

{% block title %}
    {{ title }}
{% endblock %}

{% block header %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/diva.min.css" type="text/css" />

    <script src="{{ STATIC_URL }}js/diva.min.js"></script>

    <script type="text/javascript">
    var currWit = {{curr_wit}};
    var witnesses = {{witnesses}};
    var updateWitness = function (nextWit) {
        currWit = nextWit;
        $("#myModalBody").html("Loading Metadata...");
        $("#witness-title").html("Loading Witness Title...");
        $("#witness-author").html("Loading Witness Author...");
        $.ajax({
            url: "/metadata",
            context: document.body,
            data: {'wit_id': witnesses[nextWit][0]},
            beforeSend: function (xhr) {
                xhr.overrideMimeType("text/json");
            },
        }).done(function (data, textStatus, jqXHR) {
            $("#myModalBody").html(data['table']);
            $("#witness-title").html(data['title']);
            $("#witness-author").html(data['author']);
        });
        $("#title-select").val(nextWit);
    };
    $(document).ready(function () {
        $("#diva-wrapper").diva({
            enableAutoHeight: true,
            enableAutoTitle: false,
            enableGotoPage: true,
            fixedHeightGrid: false,
            contained: true,
            iipServerURL: "http://localhost:8080/fcgi-bin/iipsrv.fcgi?FIF={{image_path}}/",
            divaserveURL: "http://localhost:8000/divaserve",
            imageDir: "{{ms_name}}",
            onScroll: function (newPageIndex) {
                var nextWit = currWit;
                var currPage = this.getCurrentPage();
                for (var i = 0; i < witnesses.length; i++) {
                    if (i + 1 >= witnesses.length) {
                        nextWit = witnesses.length - 1;
                        break;
                    }
                    else if (witnesses[i][1] <= currPage + 1 && currPage + 1 < witnesses[i+1][1]) {
                        nextWit = i;
                        break;
                    } 
                }
                if (nextWit != currWit) updateWitness(nextWit);
            },
        });
        var dv = $("#diva-wrapper").data("diva");
        $("#diva-wrapper").one("ajaxComplete", function () {
            updateWitness(currWit);
            dv.gotoPageByNumber(witnesses[currWit][1]);
            $("#title-select").change(function () {
                var val = $("#title-select").val();
                updateWitness(val);
                dv.gotoPageByNumber(witnesses[val][1]);
            });
        });
    });
    </script>
{% endblock %}

{% block wrap %}
<div class="row-fluid">
    <div class="span3">
        <h3 id="witness-title">Witness Title</h3>
        <h4 id="witness-author">Witness Author</h4>
        <dl>
            <dt>Titles in this Codex</dt>
            <dd>
                <select id="title-select">
                    {% for i,title in titles %}
                    <option value={{i}}>{{title}}</option>
                    {% endfor %}
                </select>
                <a href="#myModal" role="button" class="btn" data-toggle="modal">Show Witness Info</a>
            </dd>
        </dl>
    </div>
    <div class="span9">
    <div id="diva-wrapper"></div>
    </div>
<div>
{% endblock %}

{% block modal %}
<!-- Modal -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="myModalLabel">Metadata for {{ms_name}}</h3>
  </div>
  <div id="myModalBody" class="modal-body"></div>
  <div class="modal-footer">
    <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>
{% endblock %}