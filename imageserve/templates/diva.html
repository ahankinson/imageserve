{% extends 'main.html' %}

{% block title %}
    {{ title }}
{% endblock %}

{% block header %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/diva.min.css" type="text/css" />

    <script src="{{ STATIC_URL }}js/diva.min.js"></script>

    <script type="text/javascript">
    {% if witnesses %}
        var currWit = {{curr_wit}};
        var apiFunc = function (url) {
            func = function (kwargs, callback) {
                $.ajax({
                    url: url,
                    context: document.body,
                    data: kwargs,
                    beforeSend: function (xhr) {
                        xhr.overrideMimeType("text/json");
                    },
                }).done(function (data, textStatus, jqXHR) {
                    callback(data);
                });
            };
            return func;
        }
        var pageForWit = apiFunc("/page_for_wit");
        var witForPage = apiFunc("/wit_for_page");
        var idForWit = apiFunc("/id_for_wit");
        var updateWitness = function (nextWit) {
            currWit = nextWit;
            $("#myModalBody").html("Loading Metadata...");
            $("#witness-title").html("Loading Witness Title...");
            $("#witness-author").html("Loading Witness Author...");
            if (nextWit != -1) {
                $("#title-select").val(nextWit);
                idForWit({'ms_id': {{ms_id}}, 'wit': nextWit},
                        function (witId) {
                            $.ajax({
                                url: "/metadata",
                                context: document.body,
                                data: {'wit_id': witId},
                                beforeSend: function (xhr) {
                                    xhr.overrideMimeType("text/json");
                                },
                            }).done(function (data, textStatus, jqXHR) {
                                $("#myModalBody").html(data['table']);
                                $("#witness-title").html(data['title']);
                                $("#witness-author").html(data['author']);
                            });
                         });
            } else {
                $("#myModalBody").html(
                    "No witness has been identified for this page."
                );
                $("#witness-title").html(
                    "No witness has been identified for this page."
                );
                $("#witness-author").html("");
            }
        };
    {% endif %}
    $(document).ready(function () {
        $("#diva-wrapper").diva({
            enableAutoHeight: true,
            enableAutoTitle: false,
            enableGotoPage: true,
            fixedHeightGrid: false,
            contained: true,
            iipServerURL: "http://localhost:8080/fcgi-bin/iipsrv.fcgi?FIF={{image_path}}/",
            divaserveURL: "http://localhost:8000/divaserve",
            imageDir: "{{ms_name}}",
            {% if witnesses %}
                onScroll: function (newPageIndex) {
                    var currPage = this.getCurrentPage() + 1;
                    witForPage({'ms_id':{{ms_id}},
                                'page': currPage},
                                function (data) {
                                    if (currWit != data)
                                    updateWitness(data);
                                });
                },
            {% endif %}
        });
        var dv = $("#diva-wrapper").data("diva");
        {% if witnesses %}
            $("#diva-wrapper").one("ajaxComplete", function () {
                updateWitness(currWit);
                pageForWit({'ms_id': {{ms_id}}, 'wit': currWit},
                           function (data) {
                               dv.gotoPageByNumber(data);
                           });
                $("#title-select").change(function () {
                    var val = $("#title-select").val();
                    updateWitness(val);
                    pageForWit({'ms_id': {{ms_id}}, 'wit': currWit},
                               function (data) {
                                   dv.gotoPageByNumber(data);
                               });
                });
            });
        {% endif %}
    });
    </script>
{% endblock %}

{% block wrap %}
<div class="row-fluid">
    <div class="span3">
        {% if ismi_data %}
            {% if witnesses %}
                <h3 id="witness-title">Witness Title</h3>
                <h4 id="witness-author">Witness Author</h4>
                <dl>
                    <dt>Titles in this Codex</dt>
                    <dd>
                        <select id="title-select">
                            {% for i,title in titles %}
                            <option value={{i}}>{{title}}</option>
                            {% endfor %}
                        </select>
                        <a href="#myModal" role="button" class="btn" 
                         data-toggle="modal">Show Witness Info</a>
                    </dd>
                </dl>
            {% else %}
                <h3>
                    The ISMI data for this codex contains no witnesses.
                </h3>
            {% endif %}
        {% else %}
            <h3>No ISMI ID has been chosen for this codex.</h3>
            {% if perms.manuscript.can_change %}
                <h3>
                    <a href="/admin/imageserve/manuscript/{{ms_id}}">
                        Click to choose an ISMI ID for this codex now.
                    </a>
                </h3>
            {% endif %}
        {% endif %}
    </div>
    <div class="span9">
    <div id="diva-wrapper"></div>
    </div>
<div>
{% endblock %}

{% block modal %}
<!-- Modal -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="myModalLabel">Metadata for {{ms_name}}</h3>
  </div>
  <div id="myModalBody" class="modal-body"></div>
  <div class="modal-footer">
    <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>
{% endblock %}